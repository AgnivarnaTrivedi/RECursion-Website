<% content_for :heading do %>
	askREC
<% end %>

<style>
	
	a:hover{
		background-color: navajowhite;
	}

</style>

<p id="notice"><%= notice %></p>

<div class="container-fluid">

	<div class="col s12 m8 l8">
	    <div class="card" style="height:100%">
			<div class="text-center" style="padding: 10px">
			    <h4><%= @question.title %></h4>
			    <% @tags.each do |tag| %>
			    	<span class="new badge" data-badge-caption=""><%= tag.name %></span>
		    	<% end %>
			</div>
			<hr />
			<div class="card-content">
				<div class="text-center" style="padding: 15px;">
				    <h6><%= @question.description.html_safe %></h6>
				    <br />
					<div class="row">
						<% if current_user %>
							<div class="question_id" id='<%= @question.id %>'></div>	
							<div class="upvote_status" id='<%= current_user.already_upvoted(@question) %>'></div>
							<div class="follow_status" id='<%= current_user.already_followed(@question) %>'></div>		
						<div id='upvote_downvote'>
							<% if current_user.already_upvoted(@question) %>

								<a href='#' class='btn waves-effect' style="background-color: #1976d2" id='upvoteButton'>Downvote</a>

							<% else %>

								<a href='#' class='btn waves-effect' style="background-color: #1976d2" id='upvoteButton'>Upvote</a>

							<% end %>
							
							<button class='btn waves-effect' style="background-color: #0d47a1" id='showAnswerForm'>	Answer</button>
		
							<% if current_user.already_followed(@question) %>

								<button class='btn waves-effect waves-light' style="background-color: #1565c0" id='followButton'>Unfollow</button>

							<% else %>

								<button class='btn waves-effect waves-light' style="background-color: #1565c0" id='followButton'>Follow</button>

							<% end %>					
						</div>
						<% else %>
							<p>Please Log In to Answer</p>
						<% end %>
					</div>
				</div>
	        </div>
		</div>   	

		<div class="row">
			<% if current_user %>
			  	<div class="input-field col s11 m11 l11">
				  		<input placeholder="Add a comment" id="commentForm">
				</div>
				<div class="col s1 m1 l1">
					<button style="background-color: #2196f3; margin-top: 20px;	" class="btn" id="commentButton"><i class="material-icons">send</i></button>
				</div>					
			<% end %>
		</div>

		<div id="commentStatus"></div>
 

	</div>

	<div class="col s12 m4 l4">

		<div class="card" style="overflow: auto; height: 400px;">
			<div class="text-center" style="padding: 10px">
				<h5>Comments</h5>
			</div>
			<hr />
			<div class="card-content" id="commentSection">
				
				<% @comments.each do |comment| %>
					<div class="row">
						<div class="col s9 m9 l9">	
							<p style="word-wrap:break-word; padding: 5px;" class="cyan lighten-4"><%= comment.body %>   <b><%= comment.created_at.strftime('%H:%M, %b %d') %></b></p>
						</div>
						<div class="col s3 m3 l3 text-center">
							<p style="padding: 5px;" class="cyan darken-2">
							<% if current_user and current_user.id == comment.user_id %>
								<%= "You" %>
							<% else %>
								<%= link_to User.find(comment.user_id).nickname, users_path(User.find(comment.user_id).nickname) %>
							<% end %>
							</p>
						</div>
					</div>
				<% end %>
			</div>

		</div>


		<div class="row">

			<div class="col s6 m6 l6">	
				<div class="card" style="background-color: #F8FFF9;">
					<div class="text-center" style="padding: 10px;">
						<h6>Upvotes</h6>
					</div>
					<hr />
					<div class="card-content text-center">
						<span class="upvotes_count" style="font-size: 30px;"><%= @question.upvotes.count %></span>
					</div>
				</div>
			</div>

			<div class="col s6 m6 l6">	
				<div class="card" style="background-color: #F8FFF9;">
					<div class="text-center" style="padding: 10px;"">
						<h6>Followed by</h6>
					</div>
					<hr />
					<div class="card-content text-center">
						<span class="follow_count" style="font-size: 30px;"><%= @question.follows.count %></span>
					</div>
				</div>
			</div>

		</div>
	          

        </div>

	</div>

	<hr />

	<div class="container-fluid">
		<div id ='answerForm'>

			<div class="container">
			<%= form_for(@answer, url: answer_path) do |f| %>
				  <% if @answer.errors.any? %>
				    <div id="error_explanation">
				      <h2><%= pluralize(answer.errors.count, "error") %> prohibited this answer from being saved:</h2>
				      <ul>
				      <% answer.errors.full_messages.each do |message| %>
				        <li><%= message %></li>
				      <% end %>
				      </ul>
				    </div>
				  <% end %>

				  <div class="input-field">
				    <%= f.cktext_area :description, :as => :ckeditor, input_html: {:ckeditor => {:toolbar => 'mini'}}, required: "" %>
				  </div>
				  <br />
				  <button style="background-color: #0d47a1" class="btn waves-effect right" type="submit" name="action"><%= f.submit "Post" %></button>
			
			<% end %>
			</div>
		</div>
		<br />

		<% if @answers.any? %>
			<h4><%= @answers.count %> Answer<% if @answers.count > 1 %>s<% end %></h4>
		<% end %>
	</div>


	<div class="container">



		<% if @answers.any? %>
			<% @answers.each do |answer| %>

			    <div class="card" style="background-color: #FCFDFB;">
					<div class="card-content" style="padding: 10px">
						<h6 class='cyan' style="float:right"><%= answer.created_at.strftime('%b %d, %Y') %></h6><br />
						<h4><%= raw(answer.description) %></h4>
						<h6 class='cyan' style="display: inline-block; float: left; margin-right: 20px"><%= User.find(answer.user_id).nickname %></h6>
						<span style="display: inline-block">	
						<%= link_to image_tag(User.find(answer.user_id).image_url, size: "50x50"), users_path(User.find(answer.user_id).nickname) %>
						</span>
						
					</div>
				</div>   

			<% end %>

		<% else %>
			<h4>No Answer to this question yet</h4>
		<% end %>

	</div>

</div>




<script>
$(document).ready(function(){
	$("#answerForm").hide();
	$('#commentButton').prop('disabled', true);

	$("#commentForm").keyup(function() {
		var comment = $(this).val();
		var id = $(".question_id").attr("id");

		if( comment.length > 140){
			$('#commentStatus').hide().html('<p>A comment can be of 140 letters at max</p>').fadeIn("slow");
			$('#commentButton').prop('disabled', true);
			return;
		}
		else if( comment.length < 1 || /^[\s]*$/.test(comment) == true){
			$('#commentButton').prop('disabled', true);
			return;
		}
		else{
			$('#commentButton').prop('disabled', false);
			return;
		}

	});


	$("#commentButton").click(function(){
		
		var comment = $("#commentForm").val();
		console.log(comment);
		var id = $(".question_id").attr("id");

		$.ajax({
	 		type: 'POST',
	 		url: '/askrec/questions/'+id+'/comment',
			data: {"body": comment},
	 		success: function(){
	 			console.log("Done!!");

			 	var newComment = '<div class="row"><div class="col s9 m9 l9"><p style="word-wrap:break-word; padding: 5px;" class="cyan lighten-5">'+comment+'   <b>Now</b></p></div><div class="col s3 m3 l3 text-center"><p style="padding: 5px;" class="cyan">You</p></div></div>';
			
			 	var div = document.getElementById('commentSection');
			 	div.innerHTML = newComment + div.innerHTML;
			},
	 		error: function(){
	 			alert("Failure!");
	 		}
	 	});
	 	$("#commentForm").val("");

	});


	$("#showAnswerForm").click(function() {
		$("#answerForm").show();
		$("#showAnswerForm").prop('disabled', true);
	});

	$("#upvoteButton").click(function() {
		event.preventDefault();
		var id = $(".question_id").attr("id");
	 	var count = parseInt($(".upvotes_count").text());
	 	var status = $(".upvote_status").attr("id");
	 	
	 	$.ajax({
	 		type: 'GET',
	 		url: '/askrec/questions/'+id+'/upvote',
	 		dataType: "json",
	 		success: function(){

	 			if(status === 'false'){
	 				count++;
	 				$(".upvote_status").attr('id', 'true');
	 				$("#upvoteButton").html("Downvote");
	 			}
	 			else{
	 				count--;
	 				$(".upvote_status").attr('id', 'false');
	 				$("#upvoteButton").html("Upvote");
	 			}

				$(".upvotes_count").html(count);
			},
	 		error: function(){
	 			alert("Failure!");
	 		}
	 	})
	});

	$("#followButton").click(function() {
		event.preventDefault();
		var id = $(".question_id").attr("id");
		var count = parseInt($(".follow_count").text());
		var status = $(".follow_status").attr("id");
		$.ajax({
			type: 'GET',
			url: '/askrec/questions/'+id+'/follow',
			dataType:  "json",
			success: function(){
				if(status === 'false'){
					$(".follow_status").attr('id', 'true');
					$("#followButton").html('Unfollow');
					count++;
				}
				else{
					$(".follow_status").attr('id', 'false');
					$("#followButton").html('Follow');	
					count--;
				}
				$(".follow_count").html(count);
			},
	 		error: function(){
	 			alert("Failure!");
	 		}
		})

	});



});

</script>
